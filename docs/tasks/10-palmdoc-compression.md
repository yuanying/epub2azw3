# Task 10: PalmDoc圧縮

## 概要
テキストレコードに適用するPalmDoc圧縮を実装する。LZ77ベースの圧縮アルゴリズムにより、AZW3ファイルサイズを削減する。

## 関連
- **spec.md参照**: §4.5.1, §6.6
- **依存タスク**: Task 03（テキストレコード生成 — 圧縮インターフェースの差し替え）
- **GitHub Issue**: —

## 背景
PalmDoc圧縮はLZ77ベースのシンプルな圧縮方式。calibreおよびKindleGenがデフォルトで使用する。各テキストレコード（4096バイトブロック）に対して個別に圧縮を適用する。圧縮タイプはPalmDOCヘッダーで2に設定する。

## 実装場所
- 新規ファイル: `internal/mobi/compression.go`
- テストファイル: `internal/mobi/compression_test.go`

## 要件

### 圧縮エンコーディング規則

| バイト範囲 | 種別 | 説明 |
|-----------|------|------|
| 0x00 | リテラル | そのまま出力 |
| 0x01-0x08 | 非圧縮マーカー | 次のNバイトが非圧縮リテラル |
| 0x09-0x7F | リテラル | そのまま出力 |
| 0x80-0xBF | 後方参照 | 2バイトシーケンスで距離と長さを指定 |
| 0xC0-0xFF | スペース+リテラル | スペース(0x20) + (バイト XOR 0x80) を出力 |

### 後方参照のエンコーディング（2バイト）
- 2バイト: `[高位バイト][低位バイト]`
- 距離: `((高位 & 0x3F) << 8 | 低位)` の上位11ビット (右3ビットシフト)
- 長さ: 下位3ビット + 3
- 最大距離: 2047バイト
- 最小長: 3バイト
- 最大長: 10バイト

### 圧縮アルゴリズム
1. 入力バイト列を走査
2. 各位置で過去2047バイト以内に3バイト以上の最長一致を検索
3. 一致あり → 後方参照(2バイト)を出力
4. 一致なし:
   - スペース(0x20) + 印字可能文字(0x40-0x7F) → 1バイト圧縮(0xC0-0xFF)
   - バイト値が0x01-0x08または0x80-0xFF → 非圧縮マーカー使用
   - それ以外 → リテラル出力

### 解凍アルゴリズム
圧縮の逆操作。テスト用に実装する。

## 実装ガイドライン
- 4096バイトの入力ブロック単位で圧縮（圧縮前のサイズが4096バイト）
- 効率的な一致検索のためハッシュテーブルを使用（3バイトプレフィックスでハッシュ）
- Task 03で定義した圧縮インターフェースを実装
- PalmDOCヘッダーの圧縮タイプを2に変更（Task 03/パイプライン側の切替を含む）
- Phase 4（Task 16相当）でハッシュテーブル最適化を行うため、まずは素朴な実装でOK

## テスト方針
- 圧縮→解凍のラウンドトリップテスト（元データと一致すること）
- 空入力の圧縮
- リテラルのみのテスト（短い入力）
- 後方参照が生成されるテスト（繰り返しパターン）
- スペース+文字の圧縮テスト
- 境界値テスト（4096バイトちょうど）
- 日本語UTF-8テキストの圧縮テスト
- 圧縮後サイズが入力以下であること（最悪ケースでも膨張が限定的）

## 完了条件
- [x] PalmDoc圧縮関数
- [x] PalmDoc解凍関数（テスト用）
- [x] 圧縮インターフェースの実装（Task 03連携）
- [x] ラウンドトリップテスト
- [x] 各種エッジケーステスト
- [x] 全テストがパス
