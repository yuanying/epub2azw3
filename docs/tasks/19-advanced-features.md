# Task 19: 高度な機能

## 概要
オプショナルな高度機能群。デュアルフォーマット対応、INDXレコード、フォント埋め込み、SVG対応、MathML対応を含む。

## 関連
- **spec.md参照**: §9.5
- **依存タスク**: Task 01〜18（全基本機能）
- **GitHub Issue**: —

## 背景
Phase 1〜4で基本的なEPUB→AZW3変換は完成する。Phase 5ではオプショナルな高度機能を追加して、完全なKF8対応と高度なレイアウトサポートを実現する。各機能は独立して実装可能なため、必要に応じて取捨選択できる。

## 実装場所
- 各機能に応じた新規/既存ファイル

## 要件

### 5.1 デュアルフォーマット対応（MOBI7+KF8）

#### 概要
KF8-onlyではなく、MOBI7セクションも含むデュアルフォーマットを生成する。2011年以前のKindleデバイスとの互換性を確保する。

#### 技術的な構造
```
PDB ヘッダー
├── MOBI7 セクション
│   ├── MOBIヘッダー（KF8境界を含む）
│   ├── テキストレコード（基本HTML）
│   └── 画像レコード
├── 境界マーカー（EXTHレコード121で指定）
└── KF8 セクション
    ├── MOBIヘッダー（KF8拡張）
    ├── テキストレコード（拡張HTML/CSS）
    ├── 画像レコード
    ├── FDSTレコード
    └── INDXレコード
```

#### 実装方針
- MOBI7セクション: 簡略化されたHTML（CSS最小限、基本タグのみ）
- KF8セクション: 完全なHTML/CSS
- EXTHレコード121: KF8セクションの開始レコード番号を指定

### 5.2 INDX（インデックステーブル）

#### 概要
バイナリ形式のインデックスデータ。検索やナビゲーションの高速化に使用。

#### 内容
- タイトル、著者、目次エントリなどのインデックス化
- KF8のスケルトン構造の定義

#### 実装優先度
- 低（NCXで基本的な目次は実現可能）

### 5.3 フォント埋め込み

#### 概要
EPUB内のフォントファイル（TTF, OTF）をAZW3に埋め込む。

#### 対応フォーマット
- TrueType (.ttf)（Kindle推奨）
- OpenType (.otf)

#### 実装方針
- @font-face CSSルールを解析してフォント参照を特定
- フォントファイルをPDBレコードとして格納
- CSS内のフォント参照を更新

### 5.4 SVG対応

#### 概要
SVG画像をラスタライズしてPNG/JPEGに変換する。

#### 実装方針
- GoのSVGレンダリングライブラリを使用
- KindleのSVGサポートは限定的なため、ラスタライズが安全
- 優先度: 低

### 5.5 MathML対応

#### 概要
MathML数式をKindle互換の形式に変換する。

#### 実装方針
- MathMLを画像（PNG）にレンダリング
- または簡略化されたテキスト表現に変換
- 優先度: 低（学術文書向け）

### 5.6 将来の互換オプション
- `--force-rtl`: `page-progression-direction="rtl"` を出力HTMLに明示的に付与（縦書きがCSSで指定されていないEPUB向け）

## 実装ガイドライン
- 各機能は独立したパッケージまたはファイルとして実装
- フィーチャーフラグで有効/無効を切り替え可能
- 基本機能（Phase 1-4）への影響を最小限にする

## テスト方針
- 各機能の単体テスト
- デュアルフォーマット生成時のレコード構造検証
- フォント埋め込みの正常動作
- 既存テストに対する回帰テスト

## 完了条件
- [ ] デュアルフォーマット生成
- [ ] INDXレコード生成
- [ ] フォント埋め込み
- [ ] SVGラスタライズ
- [ ] MathML変換
- [ ] 全テストがパス
