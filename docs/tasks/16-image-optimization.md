# Task 16: 画像最適化

## 概要
EPUB内の画像をKindle表示に最適化する。リサイズ、形式変換、圧縮を行い、AZW3のサイズ制限に適合させる。

## 関連
- **spec.md参照**: §6.3
- **依存タスク**: Task 11（画像レコード生成 — 最適化後の画像をレコード化）
- **GitHub Issue**: —

## 背景
Kindleデバイスは画面サイズが限られており、大きな画像は不要にファイルサイズを増加させる。画像をKindleの推奨サイズにリサイズし、適切なフォーマットと圧縮品質で出力することで、ファイルサイズを削減しつつ表示品質を維持する。

## 実装場所
- 新規ファイル: `internal/converter/image.go`
- テストファイル: `internal/converter/image_test.go`

## 要件

### 最適化手順
1. **デコード**: `image.Decode()` で画像読み込み
2. **リサイズ**:
   - 幅が600pxを超える場合、600pxにリサイズ
   - アスペクト比を維持
   - `imaging.Lanczos` フィルタを使用
3. **形式変換**:
   - PNG → JPEG（透明度がない場合）
   - GIF → JPEG（アニメーションでない場合）
   - 透明PNGは白背景を追加してJPEGに変換、またはPNGのまま保持
4. **圧縮**:
   - JPEG品質: 80-85
   - ファイルサイズが127KB超の場合、品質を下げて再圧縮
5. **メタデータ記録**:
   - 最終サイズ（幅・高さ・バイト数）
   - 元のファイル名との対応

### サイズ制限
- Kindle旧世代互換: 127KB (127 × 1024バイト)
- KF8: 256KB

### カバー画像の特別処理
- 高解像度を保持（リサイズなし、または最小1000x625px）
- 推奨: 2500x1600px
- JPEG品質90以上

### SVG対応
- 本タスクでは **SVGのラスタライズは行わない**（Phase 5のTask 19で対応）
- SVGに遭遇した場合はスキップまたは警告（パイプラインで扱いを明示）

## データ構造

### ImageOptimizer
- MaxWidth: int — 最大幅（デフォルト600px）
- JPEGQuality: int — JPEG品質（デフォルト85）
- MaxFileSize: int — 最大ファイルサイズ（127KB）

### OptimizedImage
- Data: []byte — 最適化後のバイナリ
- Width: int — 幅
- Height: int — 高さ
- Format: string — フォーマット（"jpeg", "png"）
- OriginalPath: string — 元のパス

## 実装ガイドライン
- `github.com/disintegration/imaging` パッケージを使用
- 画像処理パイプライン: デコード → リサイズ → 形式変換 → 圧縮 → サイズ検証
- サイズ超過時の自動品質調整: 品質を5刻みで下げて再圧縮（最低60まで）
- カバー画像は別のパラメータセットで処理
- CLIオプションとの連携: `--quality`, `--max-image-size` 等（Task 17で対応）

## テスト方針
- 600px超の画像がリサイズされること
- 600px以下の画像がそのままであること
- PNG→JPEG変換（透明度なし）
- 透明PNGの処理
- JPEG品質設定が反映されること
- 127KB超の画像が再圧縮されること
- カバー画像が高解像度で保持されること
- アスペクト比が維持されること

## 完了条件
- [ ] 画像リサイズ関数
- [ ] 形式変換関数（PNG→JPEG、GIF→JPEG）
- [ ] 圧縮品質調整関数
- [ ] サイズ制限チェックと自動再圧縮
- [ ] カバー画像の特別処理
- [ ] 全テストがパス
